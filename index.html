<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>–ü–æ–¥–ø–∏—Å—å –≤ Phantom</title>
</head>
<body>

<h2>–ü–æ–¥–ø–∏—Å–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ</h2>

<button id="connect">–ü–æ–¥–∫–ª—é—á–∏—Ç—å Phantom</button>
<br><br>
<button id="sign" disabled>–ü–æ–¥–ø–∏—Å–∞—Ç—å</button>

<p id="result" style="white-space: pre-wrap; font-family: monospace; max-width: 800px; word-break: break-all;"></p>

<script src="https://unpkg.com/@solana/web3.js@1.95.3/lib/index.iife.min.js"></script>

<script>
const MESSAGE = `XSS ü™Ω good FORUM ü©∑ü¶≠
!!!!!! (‚âß‚àá‚â¶)`;

let wallet = null;
let publicKey = null;

document.getElementById("connect").onclick = async () => {
  if (typeof window.solana === 'undefined') {
    document.getElementById("result").textContent = "Phantom –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –±—Ä–∞—É–∑–µ—Ä–µ";
    return;
  }

  wallet = window.solana;

  if (!wallet.isPhantom) {
    document.getElementById("result").textContent = "–≠—Ç–æ –Ω–µ Phantom (–ø—Ä–æ–≤–µ—Ä—å —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ)";
    return;
  }

  try {
    const resp = await wallet.connect();
    publicKey = resp.publicKey;

    document.getElementById("result").textContent = 
      "–ü–æ–¥–∫–ª—é—á–µ–Ω–æ!\n–ê–¥—Ä–µ—Å: " + publicKey.toBase58();
    
    document.getElementById("sign").disabled = false;
  } catch (e) {
    document.getElementById("result").textContent = "–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –æ—Ç–º–µ–Ω–µ–Ω–æ –∏–ª–∏ –æ—à–∏–±–∫–∞";
  }
};

document.getElementById("sign").onclick = async () => {
  if (!wallet || !publicKey) {
    document.getElementById("result").textContent = "–°–Ω–∞—á–∞–ª–∞ –ø–æ–¥–∫–ª—é—á–∏ –∫–æ—à–µ–ª—ë–∫";
    return;
  }

  document.getElementById("result").textContent = "–û–∂–∏–¥–∞–Ω–∏–µ –ø–æ–¥–ø–∏—Å–∏ –≤ Phantom...";

  try {
    // –í–º–µ—Å—Ç–æ TextEncoder ‚Äî —Ä—É—á–Ω–æ–µ –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ –≤ Uint8Array (—Ä–∞–±–æ—Ç–∞–µ—Ç –≤–µ–∑–¥–µ)
    const encoder = new TextEncoder(); // –µ—Å–ª–∏ —É–ø–∞–¥—ë—Ç ‚Äî catch –ø–æ–π–º–∞–µ—Ç
    const encoded = encoder.encode(MESSAGE);

    const signed = await wallet.request({
      method: "signMessage",
      params: {
        message: encoded,
        display: "utf8"
      }
    });

    const sig = signed.signature;

    const hex = Array.from(sig)
      .map(b => b.toString(16).padStart(2, "0"))
      .join("");

    const base58Sig = solanaWeb3.bs58.encode(sig);

    document.getElementById("result").innerHTML = 
      "–£–°–ü–ï–®–ù–û!\n\n" +
      "–°–æ–æ–±—â–µ–Ω–∏–µ:\n" + MESSAGE.replace(/\n/g, "<br>") + "\n\n" +
      "–ê–¥—Ä–µ—Å:\n" + publicKey.toBase58() + "\n\n" +
      "–ü–æ–¥–ø–∏—Å—å (hex):\n" + hex + "\n\n" +
      "–ü–æ–¥–ø–∏—Å—å (base58):\n" + base58Sig;

  } catch (e) {
    let msg = "–û—à–∏–±–∫–∞ –ø–æ–¥–ø–∏—Å–∏";

    if (e.message?.includes("User rejected") || e.message?.includes("cancel")) {
      msg = "–¢—ã –æ—Ç–º–µ–Ω–∏–ª –ø–æ–¥–ø–∏—Å—å –≤ Phantom";
    } else if (e.message) {
      msg = "–û—à–∏–±–∫–∞: " + e.message;
    }

    document.getElementById("result").textContent = msg;
    console.error("–î–µ—Ç–∞–ª–∏ –æ—à–∏–±–∫–∏:", e);
  }
};
</script>

</body>
</html>
